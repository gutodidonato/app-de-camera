<!DOCTYPE html>
<html>
  <head>
    <meta name="theme-color" content="#4285f4" />
    <title>Camera com Vídeo Animado</title>
    <style>
      /*Reset */
      * {
        margin: 0;
        border: 0;
        padding: 0;
      }

      /* */
      video {
        width: 0.01vw;
      }
      body {
        background-color: black;
      }
      #canvas {
        height: 60vh;
        margin: 10%;
        width: 90%;
      }
      #video-chamada {
        position: absolute;
        top: 0%;
        right: 0%;
        width: 50%;
        margin: 10% 0 0 0;
      }
      #capture-button {
        position: absolute;
        top: 64%;
        right: 42%;
      }
      #download-link {
        position: absolute;
        top: 65%;
        right: 32%;
        color: wheat;
      }
    </style>
  </head>
  <body>
    <video id="camera-view" autoplay loop muted playsinline controls></video>
    <video id="animated-video" autoplay loop muted playsinline>
      <source src="/videoplayback.mp4" type="video/mp4" />
    </video>
    <canvas id="canvas"></canvas>
    <canvas id="video-chamada"></canvas>
    <button id="capture-button" capture>Capturar Tela</button>
    <a id="download-link" style="display: none" download="screenshot.png"
      >Baixar Captura de Tela</a
    >

    <script>
      var cameraVideo = document.getElementById("camera-view");
      var animatedVideo = document.getElementById("animated-video");
      var canvas = document.getElementById("canvas");
      var videoChamada = document.getElementById("video-chamada");
      var newContext = videoChamada.getContext("2d");
      var context = canvas.getContext("2d");

      navigator.mediaDevices
        .getUserMedia({ video: { frameRate: { ideal: 30, max: 60 } } })
        .then(function (stream) {
          cameraVideo.srcObject = stream;
        })
        .catch(function (error) {
          console.error("Erro ao acessar a câmera: ", error);
        });

      function renderFrame() {
        context.imageSmoothingEnabled = true;
        context.drawImage(
          cameraVideo,
          0,
          0,
          videoChamada.width,
          videoChamada.height
        );

        newContext.drawImage(animatedVideo, 0, 0, canvas.width, canvas.height);
        newContext.imageSmoothingEnabled = true;
        requestAnimationFrame(renderFrame);
      }

      animatedVideo.onplay = function () {
        renderFrame();
      };
    </script>
    <script>
      const captureButton = document.getElementById("capture-button");
      const downloadLink = document.getElementById("download-link");

      captureButton.addEventListener("click", () => {
        // Captura a tela e salva
        navigator.mediaDevices
          .getDisplayMedia({ video: { mediaSource: "screen" } })
          .then((stream) => {
            const videoTrack = stream.getVideoTracks()[0];
            const videoCapture = new ImageCapture(videoTrack);
            return videoCapture.grabFrame();
          })
          .then((imageBitmap) => {
            var canvas = document.createElement("canvas");
            var context = canvas.getContext("2d");
            canvas.width = imageBitmap.width;
            canvas.height = imageBitmap.height;
            context.drawImage(imageBitmap, 0, 0);
            downloadLink.download = "foto.png";
            downloadLink.href = canvas.toDataURL();
            downloadLink.style.display = "block";
          })
          .catch((error) => {
            console.error("Erro ao capturar tela: ", error);
          });
      });
    </script>
  </body>
</html>
